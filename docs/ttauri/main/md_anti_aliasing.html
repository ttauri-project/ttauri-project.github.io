<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TTauri: Perceptive correct anti-aliasing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="version_dropdown.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TTauri
   </div>
   <div id="projectbrief">A low latency retained GUI</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Perceptive correct anti-aliasing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md34"></a>
Terms</h1>
<h2><a class="anchor" id="autotoc_md35"></a>
Linear-sRGB color space</h2>
<p>Linear-sRGB is an inaccurate term describing a color space based on the sRGB color primaries and white point, but with a linear transfer function.</p>
<p>The color component values have a range between 0.0 and 1.0 and are represented as floating point values. In certain cases values outside the 0.0 to 1.0 range are allowed to handle luminance values beyond 80 cm/m2 for HDR, or negative values which represent colors outside of the triangle of the sRGB color primaries.</p>
<p>This is the color space that is used inside fragment shaders on a GPU.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Luminance (Y)</h2>
<p>The luminance is a physical linear indication of brightness.</p>
<p>In this paper we use the range of luminance values between 0.0 and 1.0 to be mapped linear to 0 cd/m2 to 80 cd/m2; which is the standard range of sRGB screen-luminance-level.</p>
<p>The luminance value is calculated from the linear-sRGB values as follows:</p>
<div class="fragment"><div class="line">Y = 0.2126 * R + 0.7152 * G + 0.0722 * B</div>
</div><!-- fragment --><p>My intuition of luminance calculations in high-gamut extended-sRGB color space is that the luminance is always positive. Since if a color outside of the standard sRGB triangle is selected at least one of the components must be a positive enough value to force the luminance to be above zero. Having only positive values is important for taking the square root, see the next section.</p>
<p><a href="https://en.wikipedia.org/wiki/Relative_luminance">https://en.wikipedia.org/wiki/Relative_luminance</a></p>
<h2><a class="anchor" id="autotoc_md37"></a>
Lightness (L)</h2>
<p>Lightness is the perceptual uniform indication of brightness.</p>
<p>In this paper we use the range of lightness values between 0.0 and 1.0 to be mapped non-linear to 0 cd/m2 to 80 cd/m2. which is the standard range of <a href="https://en.wikipedia.org/wiki/SRGB">sRGB</a> screen-luminance-level.</p>
<p>The lightness and luminance value can be translated as follows:</p>
<div class="fragment"><div class="line">L = sqrt(Y)</div>
<div class="line">Y = L * L</div>
</div><!-- fragment --><p>The formula above is an approximation made in 1920, the current well accepted approximation is closer to cube-root curve with a linear section for dark values used in the 1976's CIELAB color space. However the square-root curve is accurate enough for the use-case of anti-aliasing glyphs and is much faster in hardware and easier to use when doing the calculations for this paper.</p>
<p><a href="https://en.wikipedia.org/wiki/Lightness">https://en.wikipedia.org/wiki/Lightness</a></p>
<h1><a class="anchor" id="autotoc_md38"></a>
The problem</h1>
<p>As everyone knows alpha compositing of two images must be done in the linear color space or there will be color and/or brightness shifts over the range of alpha values.</p>
<p>If however we linearly convert the pixel coverage of an anti-aliased line to an alpha value between 0.0 and 1.0 we get the issue that the perceived width of the line is different between light-on-dark or dark-on-light.</p>
<p>Below we calculate what we will perceptional see when anti-aliasing a vertical line of two pixels wide centered at x=2.25. On the left side a white line on black background and on the right side the black line on a white background.</p>
<div class="fragment"><div class="line">           white on black-background    black on white-background</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">coverage  | 0% |25% |100%|75% | 0% |   | 0% |25% |100%|75% | 0% |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">          </div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">alpha     |0.0 |0.25|1.0 |0.75|0.0 |   |0.0 |0.25|1.0 |0.75|0.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line"> </div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">luminance |0.0 |0.25|1.0 |0.75|0.0 |   |1.0 |0.75|0.0 |0.25|1.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line"> </div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">lightness |0.0 |0.5 |1.0 |0.87|0.0 |   |1.0 |0.87|0.0 |0.5 |1.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
</div><!-- fragment --><p>The perceived line width of "white on black-background" is: <code>width = 0.0 + 0.5 + 1.0 + 0.87 + 0.0 = 2.37</code></p>
<p>The perceived line width of "black on white-background" is: <code>width = 5 - (1.0 + 0.87 + 0.0 + 0.5 + 1.0) = 1.63</code></p>
<p>As you can see the perceived width of the line is significant different especially when anti-aliasing objects which are thin, such as the lines on a glyph.</p>
<h1><a class="anchor" id="autotoc_md39"></a>
The solution</h1>
<p>There are some papers that mention the problem of the change of apparent thickness of glyphs when rendering black text or white text. Most of those papers go on to explain this stems from not doing linear compositing, or explaining that the font was designed for black on white.</p>
<p>However as you see from the calculations in the previous section this has nothing to do with the design of a font, because it shows up even when rendering a single line. Also if you would render the font without anti-aliasing these problems no longer exist, such as when rendering with a high resolution printer.</p>
<p>Problems like this even happen with physical anti-alias filters, such as when using an anti-alias glass in front of a image sensor, which scatter the photons over range of pixels. It often shows as a reduction of contrast of textured images and on sharp edges, normally this is solved by increasing the contrast of high frequency content, such as using a sharpen-filter, or with professional cameras using a equalizer tuned on the whole optical system.</p>
<p>Since with computer graphics we have control over anti-aliasing itself we can make the algorithm mix the foreground and background color on a perceptional uniform gradiant.</p>
<p>The calculation below shows how to convert an anti-alias-pixel-coverage value to an alpha value, when this pixel coverage is in a perceptional uniform space.</p>
<p>First we need to calculate the foreground and background lightness, based on the final composite of the foreground and background color using the two alpha values 0.0 and 1.0. This definition will allow for semi-transparent foreground colors.</p>
<div class="fragment"><div class="line">Yfront = 0.2126 * Rfront + 0.7152 * Gfront + 0.0722 * Bfront</div>
<div class="line">Yback = 0.2126 * Rback + 0.7152 * Gback + 0.0722 * Bback</div>
<div class="line">Lfront = sqrt(Yfront)</div>
<div class="line">Lback = sqrt(Yback)</div>
</div><!-- fragment --><p>By mixing the foreground and background lightness using the coverage value, we now have the target lightness for that coverage value.</p>
<div class="fragment"><div class="line">Ltarget = mix(Lback, Lfront, coverage)</div>
</div><!-- fragment --><p>We can convert this target lightness to a target luminance, which can then be used to find the alpha value needed to reach that target from the foreground and background luminance. If the luminance of the background and foreground are the same, then that means only the color is different, in that case linearly map the coverage to alpha.</p>
<div class="fragment"><div class="line">Ytarget = Ltarget * Ltarget</div>
<div class="line">alpha = (Ytarget - Yback) / (Yfront - Yback)       if Yfront != Yback</div>
<div class="line">alpha = coverage                                   otherwise</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md40"></a>
Example</h2>
<p>Below we calculate what we will perceptional see when anti-aliasing a vertical line of two pixels wide centered at x=2.25. On the left side a white line on black background and on the right side the black line on a white background.</p>
<div class="fragment"><div class="line">           white on black-background    black on white-background</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">coverage  | 0% |25% |100%|75% | 0% |   | 0% |25% |100%|75% | 0% |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">                                        ((1 - coverage)^2 - 1) / -1</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">alpha     |0.0 |.062|1.0 |.562|0.0 |   |0.0 |.438|1.0 |.938|0.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">                                        1 - alpha</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">luminance |0.0 |.062|1.0 |.562|0.0 |   |1.0 |.562|0.0 |.062|1.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">                                        sqrt(luminance)</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
<div class="line">lightness |0.0 |0.25|1.0 |0.75|0.0 |   |1.0 |0.75|0.0 |0.25|1.0 |</div>
<div class="line">          +----+----+----+----+----+   +----+----+----+----+----+</div>
</div><!-- fragment --><p>The perceived line width of "white on black-background" is: <code>width = 0.0 + 0.25 + 1.0 + 0.75 + 0.0 = 2</code></p>
<p>The perceived line width of "black on white-background" is: <code>width = 5 - (1.0 + 0.75 + 0.0 + 0.25 + 1.0) = 2</code></p>
<h1><a class="anchor" id="autotoc_md41"></a>
sub-pixel anti-aliasing</h1>
<p>During sub-pixel anti-aliasing we get a coverage value at each sub-pixel location.</p>
<p>For a perceptional conversion of those coverage value to an alpha value we are interested in the lightness of the full pixel after compositing with the two alpha values of 0.0 and 1.0.</p>
<p>After that we have an alpha value for each sub-pixel, then we do linear compositing on each sub-pixel separate. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" width="104" height="31" alt="doxygen"/></a> 1.8.17
</small></address>
</body>
</html>
