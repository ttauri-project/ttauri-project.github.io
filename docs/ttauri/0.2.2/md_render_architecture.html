<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TTauri: render_architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="version_dropdown.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TTauri
   </div>
   <div id="projectbrief">A low latency retained GUI</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">render_architecture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>XXX Depth buffer can be used as per-primative clipping/stencil buffer.</p>
<h1><a class="anchor" id="autotoc_md126"></a>
Render architecture</h1>
<p>Vulkan is used as the backend for rendering windows.</p>
<div class="fragment"><div class="line">  +---------+</div>
<div class="line">  | Window  |</div>
<div class="line">  +---------+</div>
<div class="line">       |      </div>
<div class="line">   Tone Mapper</div>
<div class="line">      | |</div>
<div class="line">      | +---------------+</div>
<div class="line">      |                 |</div>
<div class="line"> +---------+            |</div>
<div class="line"> | f16rgba |            |</div>
<div class="line"> +---------+            |</div>
<div class="line">      |                 |</div>
<div class="line">  SDF Shader            |</div>
<div class="line">     | |                |</div>
<div class="line">     | +-------------+  |</div>
<div class="line">     |               |  |</div>
<div class="line">+---------+      +---------+--------+</div>
<div class="line">|  Atlas  |      | f16rgba | Depth  |</div>
<div class="line">+---------+      +---------+--------+</div>
<div class="line">                   |  |  |</div>
<div class="line">                   |  |  +----------------------+</div>
<div class="line">                   |  +-----------+             |</div>
<div class="line">                   |              |             |</div>
<div class="line">              Image Shader    Flat Shader   Box Shader</div>
<div class="line">                   |</div>
<div class="line">              +---------+</div>
<div class="line">              |  Atlas  |</div>
<div class="line">              +---------+</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md127"></a>
Window</h2>
<p>The swap-chain of the window will consist of RGBA images with alpha set to 1.</p>
<p>The window may either have the sRGB colour space, or the extended-float16-sRGB color space.</p>
<h2><a class="anchor" id="autotoc_md128"></a>
Single pass, five sub-passes.</h2>
<p>The whole render architecture is using a single pass with five sub-passes.</p>
<p>By using a single pass the shader of the sub-passes are able to efficiently read from the frame-buffer. This frame buffer can be emphemeral and be located completely in fast on-GPU-chip memory. This will make rendering on mobile GPUs a lot more efficient compared to multi-pass architectures.</p>
<p>This shared frame buffer is in float-16 extended-sRGB, which allows for HDR/WCG (High Dynamic Range / Wide Color Gamut). The frame buffer also includes a depth image.</p>
<p>The five sub-passes are:</p><ul>
<li>Flat Shader - Render simple non-anti-aliased quads.</li>
<li>Box Shader - Render anti-aliased rectangles with rounded corners.</li>
<li>Image Shader - Render anti-aliased texture mapped quads.</li>
<li>SDF Shader - Render text-glyphs with subpixel-anti-aliasing.</li>
<li>Tone Mapper - Convert HDR/WCG image to the reduced range of the display.</li>
</ul>
<h2><a class="anchor" id="autotoc_md129"></a>
Text Shaping</h2>
<p>Steps of text-shaping:</p><ul>
<li>Start: with a list of style-graphemes in logical ordering. The style-grapheme contains the Unicode-NFC and each grapheme as a style. Latin automatic ligatures such as 'ffi' are illigal and should never be composed into a single grapheme.</li>
<li>Unicode-bidirectional-algorithm: This will put the list of graphemes in left-to-right render order. The new graphemes are in the form style-index-grapheme, here the index points back to the original order.</li>
<li>Glyph lookup: Each style-index-grapheme is looked up and converted into a set of font-glyph-size-color-index. The search-priority algorithm will be described below.</li>
<li>Glyph morphing: Process a sequence of glyphs from the same font through the font's glyph morphing algorithms. The resulting font-glyph-size-color-index may contain fewer or more glyphs due to this morphing. This is also the place where ligatures like 'ffi' are constructed by the font itself.</li>
<li>Line breaking: based on a given width, extra line breaks are added to the text.</li>
<li>Advance and kerning: Each glyph is assigned a screen position based on the advance and kerning algorithms of the font.</li>
<li>Output 1: A list of vertex-points with screen-, texture- and color coordinates. And a index back to the original graphemes in logical ordering.</li>
<li>Output 2: A list of carret locations, by index.<ul>
<li>It is possible for a single index to have up to two locations, due to left-to-right and right-to-left switching.</li>
<li>It is possible to use this list to find the nearest carret location to the mouse cursor.</li>
<li>The carret location list also contains the carret height and slant.</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md130"></a>
Glyph Lookup algorithm</h3>
<ol type="1">
<li>Lookup grapheme's NFC code points in the code-point-to-font table and take the intersection of fonts.</li>
<li>Lookup grapheme's NFD code points in the code-point-to-font table and take the intersection of fonts.</li>
<li>Find the closest matching font compared to the font-style and fall-back to the Noto font.</li>
<li>Open the matching font.</li>
<li>Lookup glyphs matching the code points from the grapheme's (NFC primary, NFD secondary).</li>
<li>If next grapheme's style is the same, then try looking up the code-points in the current font, otherwise start at 1.</li>
<li>Otherwise start at 1. with the next grapheme.</li>
</ol>
<p>A grapheme's code point is looked up into the code-point-to-fonts table. he returned fonts are then matched with the font-style of the grapheme.</p>
<p>This font is cached based on the style, and any code point is first checked with this cached font. If the code point is not found then the full lookup is done.</p>
<h3><a class="anchor" id="autotoc_md131"></a>
Font styles</h3>
<p>A font style is a 32 bit description of how a grapheme should be displayed. It is only 32 bit so that it is accompanied with each attributed-grapheme.</p>
<p>A font-style has the following characteristics:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight">Bits </th><th class="markdownTableHeadLeft">Name </th><th class="markdownTableHeadLeft">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">24:31 </td><td class="markdownTableBodyLeft">Super-Family ID </td><td class="markdownTableBodyLeft">Super font family id 0-255. 0 = Noto  </td></tr>
</table>
<p>23 | Serif | 22 | Monospaced | Serif + Monospace = Slab 21 | Italic | Italic / Oblique 20 | Condensed | 16:19 | Weight | See weight table below. 8:15 | Optical size | Design size in 0-255 pt 0: 7 | Color index |</p>
<p>The characteristics are read from the 'feat' table or parsed from the ilename.</p>
<p>The font characteristic struct is ordered so that the nearest match can be found using nearest unsigned integer comparison. The color index should be ignored in such a case.</p>
<p>Weight table:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight">Code </th><th class="markdownTableHeadRight">Value </th><th class="markdownTableHeadLeft">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">0 </td><td class="markdownTableBodyRight">100 </td><td class="markdownTableBodyLeft">Thin / Hairline  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">1 </td><td class="markdownTableBodyRight">200 </td><td class="markdownTableBodyLeft">Ultra-light / Extra-light  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">2 </td><td class="markdownTableBodyRight">300 </td><td class="markdownTableBodyLeft">Light  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">3 </td><td class="markdownTableBodyRight">400 </td><td class="markdownTableBodyLeft">Normal / Regular  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">4 </td><td class="markdownTableBodyRight">500 </td><td class="markdownTableBodyLeft">Medium  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">5 </td><td class="markdownTableBodyRight">600 </td><td class="markdownTableBodyLeft">Semi-bold / Demi-bold  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">6 </td><td class="markdownTableBodyRight">700 </td><td class="markdownTableBodyLeft">Bold  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">7 </td><td class="markdownTableBodyRight">800 </td><td class="markdownTableBodyLeft">Extra-bold / Ultra-bold  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight">8 </td><td class="markdownTableBodyRight">900 </td><td class="markdownTableBodyLeft">Heavy / Black  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight">9 </td><td class="markdownTableBodyRight">950 </td><td class="markdownTableBodyLeft">Extra-black / Ultra-black  </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md132"></a>
Themes</h2>
<p>A theme consists of predefined colors, fonts and button shapes. A theme is loaded from a json file. The theme directory is scanned for all themes and from the preferences the user can select the current theme at runtime.</p>
<h3><a class="anchor" id="autotoc_md133"></a>
Colors</h3>
<h4><a class="anchor" id="autotoc_md134"></a>
Accent Color</h4>
<h4><a class="anchor" id="autotoc_md135"></a>
Semantic Color</h4>
<h4><a class="anchor" id="autotoc_md136"></a>
Custom Color</h4>
<p>Custom colors are for application specific widgets. These colors may also be modified by the application at runtime. For example an audio application may use custom colours for drawing the audio level meters.</p>
<h3><a class="anchor" id="autotoc_md137"></a>
Font Styles</h3>
<h3><a class="anchor" id="autotoc_md138"></a>
Button shapes</h3>
<h2><a class="anchor" id="autotoc_md139"></a>
Box Pipeline</h2>
<p>The box-pipeline is designed to draw axis-aligned quads with:</p><ul>
<li>A fill color.</li>
<li>An anti-aliases border of a certain thickness and color.</li>
<li>An drop shadow around the border of a certain color.</li>
<li>An inlay shadow inside the border of a certain color.</li>
<li>Rounded and cut corners.</li>
</ul>
<p>By using "texture" coordinates the fragment shader knows the distance towards an edge. Together with a factor to convert the texture coordinate to pixel distance from each edge. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.png" width="104" height="31" alt="doxygen"/></a> 1.8.17
</small></address>
</body>
</html>
